<!-- üó∫Ô∏è Asset Distribution Modal - Dark Theme -->
<div class="modal-overlay bg-dark bg-opacity-75" (click)="closeModal()">
  <div class="modal-container bg-dark text-light rounded-3 shadow-lg" (click)="$event.stopPropagation()" style="border: 1px solid #2a2a2a;">
    <!-- Header -->
    <div class="modal-header border-bottom border-secondary p-4">
      <div class="header-left">
        <h4 class="modal-title fw-bold mb-1">
          <i class="bi bi-pin-map-fill text-primary me-2"></i>
          Distribution for "{{ assetType.name }}"
        </h4>
        <p class="asset-summary text-muted mb-0">
          <span class="text-light">{{ getTotalDistributed() }}</span> of
          <span class="text-light">{{ assetType.total_quantity || 0 }}</span>
          deployed (<span class="text-info">{{ getDistributionPercentage() }}%</span>)
        </p>
      </div>
      <button class="btn-close btn-close-white" (click)="closeModal()" aria-label="Close"></button>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-section p-5 text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading distribution data...</p>
    </div>

    <!-- Distribution Table -->
    <div *ngIf="!loading" class="modal-body">
      <!-- Consistency Warning -->
      <div
        *ngIf="showDiscrepancies && consistencyValidation?.has_discrepancies"
        class="consistency-alert"
      >
        <div class="alert-header">
          <i class="fas fa-exclamation-triangle warning-icon"></i>
          <h5>‚ö†Ô∏è Data Consistency Issues Detected</h5>
          <button class="btn-dismiss" (click)="dismissDiscrepancies()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <p class="alert-message">
          The following locations have discrepancies between declared and
          computed quantities:
        </p>
        <ul class="discrepancy-list">
          <li
            *ngFor="let disc of consistencyValidation.discrepancies"
            class="discrepancy-item"
          >
            <strong>{{ disc.location_name }}:</strong> Declared
            {{ disc.declared_quantity }}, Found {{ disc.computed_quantity }}
            <span
              class="difference"
              [class.positive]="disc.difference > 0"
              [class.negative]="disc.difference < 0"
            >
              ({{ disc.difference > 0 ? '+' : '' }}{{ disc.difference }})
            </span>
          </li>
        </ul>
        <div class="alert-actions">
          <button class="btn btn-warning" (click)="reconcileDistribution()">
            <i class="fas fa-sync-alt"></i>
            Auto-Reconcile Data
          </button>
          <button class="btn btn-secondary" (click)="validateConsistency()">
            <i class="fas fa-redo"></i>
            Re-validate
          </button>
        </div>
      </div>

      <div class="distribution-overview">
        <div class="overview-stats">
          <div class="stat-item">
            <span class="stat-value">{{ distribution.length }}</span>
            <span class="stat-label">Locations</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getTotalDistributed() }}</span>
            <span class="stat-label">Total Deployed</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{
              (assetType.total_quantity || 0) - getTotalDistributed()
            }}</span>
            <span class="stat-label">Unassigned</span>
          </div>
        </div>
      </div>      <!-- Distribution Table -->
      <div class="table-container">
        <table class="distribution-table table table-dark table-hover table-borderless" *ngIf="distribution.length > 0">
          <thead class="border-bottom border-secondary">
            <tr>
              <th class="ps-4"><i class="bi bi-geo-alt me-2"></i>Location</th>
              <th class="text-center">Quantity</th>
              <th class="text-center">Last Updated</th>
              <th class="text-center pe-4">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of distribution" class="distribution-row align-middle">
              <td class="location-cell ps-4">
                <i class="bi bi-geo-fill text-primary me-2"></i>
                {{ item.location?.name || getLocationName(item.location_id) }}
              </td>
              <td class="text-center quantity-cell">
                <span class="badge bg-primary rounded-pill px-3 py-2">{{ item.quantity }}</span>
              </td>
              <td class="text-center date-cell text-muted">
                {{ item.last_updated | date : "MMM dd, yyyy" }}
              </td>
              <td class="text-center actions-cell pe-4">
                <button
                  class="btn btn-sm btn-outline-info rounded-circle"
                  (click)="initiateTransfer()"
                  title="Transfer from this location"
                >
                  <i class="bi bi-arrow-left-right"></i>
                </button>
              </td>
            </tr>
          </tbody>
          <tfoot class="border-top border-secondary">
            <tr class="total-row">
              <td class="ps-4"><strong>Total Distributed</strong></td>
              <td class="text-center">
                <strong class="text-success">{{ getTotalDistributed() }}</strong>
              </td>
              <td colspan="2" class="text-center pe-4">
                <span class="badge bg-dark text-info border border-info">
                  {{ getDistributionPercentage() }}% of total inventory
                </span>
              </td>
            </tr>
          </tfoot>
        </table>

        <!-- Empty State -->
        <div *ngIf="distribution.length === 0" class="empty-state text-center p-5">
          <i class="bi bi-inboxes text-muted" style="font-size: 3rem;"></i>
          <h5 class="mt-3 mb-2">No Distribution Found</h5>
          <p class="text-muted mb-4">This asset has not been distributed to any locations yet.</p>
          <button class="btn btn-primary" (click)="initiateTransfer()">
            <i class="bi bi-plus-circle me-2"></i>
            Start Distribution
          </button>
        </div>
      </div>
    </div>

    <!-- Footer Actions -->
    <div class="modal-footer border-top border-secondary p-3">
      <button class="btn btn-outline-secondary me-2" (click)="closeModal()">
        <i class="bi bi-x-lg me-2"></i>
        Close
      </button>
      <button class="btn btn-success" (click)="initiateTransfer()">
        <i class="bi bi-arrow-left-right me-2"></i>
        Transfer Assets
      </button>
    </div>
  </div>
</div>
