<div class="grid-1" *ngIf="data && !loading">
  <div class="form-container">
    <div class="title-section">
      <h5 class="w-fit">
        {{ title }}
      </h5>
      <div class="d-flex">
        <a class="btn btn-light" [routerLink]="page.listUrl">
          <i class="bi bi-arrow-left"></i>
          Back
        </a>
      </div>
    </div>
    <form class="body">
      <div class="grid-2">
        <div class="form-floating mb-4">
          <select
            class="form-select"
            id="type"
            [disabled]="isEdit"
            [(ngModel)]="data.site"
            [ngModelOptions]="{ standalone: true }"
            required
          >
            <option value="" disabled selected>Select Site...</option>
            <option [value]="location.Id" *ngFor="let location of sites">
              {{ location.ItemValue.Name }}
            </option>
          </select>
          <label for="site">Site</label>
        </div>

        <div class="form-floating mb-4">
          <input
            type="text"
            class="form-control"
            id="requestedBy"
            placeholder="Requested By"
            [(ngModel)]="data.requestedBy"
            [ngModelOptions]="{ standalone: true }"
            [disabled]="isEdit"
            required
          />
          <label for="requestedBy"> Requested By </label>
        </div>

        <div class="form-floating mb-4">
          <select
            class="form-select"
            id="type"
            [disabled]="isEdit"
            [(ngModel)]="data.type"
            [ngModelOptions]="{ standalone: true }"
            required
          >
            <option value="stock">Stock Request</option>
            <option value="purchase">Purchase Request</option>
          </select>
          <label for="type">Requisition Type</label>
        </div>

        <div class="form-floating mb-4" *ngIf="isEdit">
          <input
            type="text"
            class="form-control"
            id="requestedBy"
            placeholder="Status"
            [(ngModel)]="data.status"
            [ngModelOptions]="{ standalone: true }"
            [disabled]="isEdit"
            style="text-transform: uppercase"
            required
          />
          <label for="requestedBy"> Status </label>
        </div>

        <div class="form-floating mb-4" *ngIf="isEdit && data.approvedBy">
          <input
            type="text"
            class="form-control"
            id="requestedBy"
            placeholder="Status"
            [(ngModel)]="data.approvedBy"
            [ngModelOptions]="{ standalone: true }"
            [disabled]="isEdit"
            style="text-transform: uppercase"
            required
          />
          <label for="requestedBy"> Approved By </label>
        </div>
        <div
          class="form-floating mb-4"
          *ngIf="isEdit && data.status !== 'pending'"
        >
          <div class="form-control">
            {{ data.lastUpdatedDate | date }}
          </div>
          <label for="requestedBy">
            {{ data.status === "approved" ? "Approved On" : "Rejected On" }}
          </label>
        </div>
      </div>

      <div *ngIf="selectedAssets" class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th style="width: 40%">Asset Name</th>
              <th>Qty</th>
              <th style="width: 30%">Room</th>
              <th *ngIf="!isClosed" >Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of selectedAssets; let i = index">
              <td>{{ item.assetName }}</td>
              <td>
                <input
                  (change)="updateItem(item)"
                  type="number"  [disabled]="isClosed"
                  [(ngModel)]="item.quantity"
                  [ngModelOptions]="{ standalone: true }"
                  class="form-control"
                />
              </td>
              <td>
                <!-- Room Dropdown -->
                <select
                
                  class="form-select"
                  [(ngModel)]="item.roomId"  [disabled]="isClosed"
                  [ngModelOptions]="{ standalone: true }"
                  (change)="updateItem(item)"
                >
                  <option value="0" disabled selected>Select Room...</option>
                  <option [value]="room.Id" *ngFor="let room of locations">
                    {{ room.ItemValue.Name }}
                  </option>
                </select>
              </td>
              <td>
                <button class="btn btn-danger btn-sm" *ngIf="!isClosed" (click)="removeItem(i)">
                  Remove
                </button>
              </td>
            </tr>
            <!-- No Asset Selected -->
            <tr *ngIf="!selectedAssets.length">
              <td colspan="4" class="text-center">
                <p class="p-3">
                  <i class="bi bi-exclamation-triangle text-warning"></i>
                  No Asset Selected
                </p>
              </td>
            </tr>

            <!-- Add Line -->
            <tr *ngIf="!isClosed">
              <td colspan="4" class="text-center">
                <div class="d-flex justify-content-end">
                  <button
                    type="button"
                    class="btn btn-primary btn-sm"
                    (click)="openAssetModal()"
                  >
                    {{
                      selectedAssets.length ? "Add Another Asset" : "Add Asset"
                    }}
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button
        *ngIf="!isEdit"
        type="submit"
        class="w-100 btn btn-success mt-3"
        (click)="save()"
      >
        Save Requisition
      </button>
    </form>
  </div>
</div>

<!-- Asset Selection Modal -->
<div *ngIf="showModal && assets.length" class="modal-overlay">
  <div class="modal-container fade-in">
    <div class="header d-flex justify-content-between align-items-center p-2">
      <h6>Select Asset</h6>
      <i class="bi bi-x-lg pointer" (click)="showModal = false"></i>
    </div>
    <div class="content p-3">
      <input
        type="text"
        [(ngModel)]="searchAsset"
        class="form-control mb-3"
        placeholder="Search..."
      />

      <ul class="list-group">
        <li
          class="list-group-item pointer"
          *ngFor="let asset of assets | searchAsset : searchAsset"
          (click)="selectAsset(asset)"
        >
          {{ asset.name }}
        </li>
      </ul>
    </div>
  </div>
</div>

<app-loader *ngIf="loading" />
